<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>–í—ã–±–æ—Ä –º–µ—Å—Ç</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#f3f4f6; --card:#fff; --text:#0b0b0c; --muted:#6b7280; --line:#e5e7eb;
      --shadow:0 18px 40px rgba(0,0,0,.12);
      --seat:#8b93a6; --seatText:#fff;
      --sold:#d1d5db;
      --selOutline:#111827;
      --price1:#1f7a2e;   /* 2500 */
      --price2:#b455d6;   /* 3500 */
      --price3:#ff2b2b;   /* 5000 */
      --price4:#17ff17;   /* 5500 */
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text);}
    .wrap{max-width:980px;margin:0 auto;padding:12px 12px 40px;}
    .top{display:flex;gap:10px;justify-content:space-between;align-items:center;margin:10px 0 12px;}
    a.pill{display:inline-flex;gap:8px;align-items:center;padding:10px 12px;border:1px solid var(--line);border-radius:999px;background:#fff;color:var(--text);text-decoration:none;font-weight:800;font-size:14px}
    .card{background:#fff;border:1px solid var(--line);border-radius:20px;box-shadow:var(--shadow);overflow:hidden;}
    .head{padding:14px 16px;border-bottom:1px solid var(--line);display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between}
    .h1{font-size:22px;font-weight:900}
    .sub{font-size:13px;color:var(--muted);font-weight:700}
    .legend{padding:14px 16px;border-bottom:1px solid var(--line);display:flex;gap:16px;flex-wrap:wrap;align-items:center}
    .lg{display:flex;gap:10px;align-items:center;font-weight:800}
    .sq{width:18px;height:18px;border-radius:2px;background:#999}
    .hallTitle{margin:0;padding:18px 16px;text-align:center;color:#fff;background:linear-gradient(180deg,#1a1a1b,#000);font-weight:900;font-size:26px}
    .hall{padding:18px 16px 8px;background:#fff;}
    .rows{display:flex;flex-direction:column;gap:12px;align-items:center}
    .row{display:flex;gap:10px;align-items:center}
    .rowNum{width:22px;text-align:right;font-weight:900;color:#111}
    .seats{display:flex;gap:8px;flex-wrap:nowrap}
    .seat{
      width:28px;height:28px;border-radius:2px;background:var(--seat);color:var(--seatText);
      display:grid;place-items:center;font-size:12px;font-weight:900;user-select:none;cursor:pointer;
      box-shadow:0 2px 0 rgba(0,0,0,.12);
      transition:transform .05s ease, filter .08s ease;
    }
    .seat:active{transform:scale(.98)}
    .seat.sold{background:var(--sold);color:#6b7280;cursor:not-allowed;box-shadow:none}
    .seat.sel{outline:3px solid var(--selOutline);outline-offset:1px}
    .seat.p2500{background:var(--price1)}
    .seat.p3500{background:var(--price2)}
    .seat.p5000{background:var(--price3)}
    .seat.p5500{background:var(--price4)}
    .stage{margin:14px 16px 12px;border-radius:12px;background:linear-gradient(180deg,#1a1a1b,#000);color:#fff;text-align:center;font-weight:900;font-size:34px;padding:18px 12px}
    .footer{padding:14px 16px;border-top:1px solid var(--line);display:grid;grid-template-columns:1fr 240px;gap:12px;align-items:center}
    .total{font-size:44px;font-weight:900}
    .buyBtn{height:70px;border:none;border-radius:12px;background:linear-gradient(180deg,#1a1a1b,#000);color:#fff;font-weight:900;font-size:22px;cursor:pointer;box-shadow:0 16px 30px rgba(0,0,0,.18)}
    .form{padding:14px 16px 18px;border-top:1px solid var(--line);background:#fff}
    .field{display:flex;flex-direction:column;gap:8px;margin:10px 0}
    .field input{padding:16px 14px;border:1px solid var(--line);border-radius:12px;font-size:16px;font-weight:700;outline:none;background:#fff}
    .hint{color:var(--muted);font-weight:700;font-size:13px;margin-top:8px}
    @media(max-width:720px){
      .footer{grid-template-columns:1fr 160px}
      .total{font-size:38px}
      .buyBtn{height:64px;font-size:20px}
    }
  </style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <a class="pill" href="#" id="back">‚Üê –ù–∞–∑–∞–¥</a>
    <a class="pill" href="wallet.html">üí≥ –ö–æ—à–µ–ª—ë–∫ <b id="bal">0 ‚ÇΩ</b></a>
  </div>

  <div class="card">
    <div class="head">
      <div>
        <div class="h1" id="title">–í—ã–±–æ—Ä –º–µ—Å—Ç</div>
        <div class="sub" id="meta">...</div>
      </div>
      <div class="sub" style="text-align:right">
        <div><b>–í—ã–±–æ—Ä –º–µ—Å—Ç</b></div>
        <div>–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –º–µ—Å—Ç–æ, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å</div>
      </div>
    </div>

    <div class="legend">
      <div class="lg"><span class="sq" style="background:var(--seat)"></span> —Å–≤–æ–±–æ–¥–Ω–æ</div>
      <div class="lg"><span class="sq" style="background:var(--sold)"></span> –∑–∞–Ω—è—Ç–æ</div>
      <div class="lg"><span class="sq" style="background:var(--price1)"></span> 2500 —Ä—É–±.</div>
      <div class="lg"><span class="sq" style="background:var(--price2)"></span> 3500 —Ä—É–±.</div>
      <div class="lg"><span class="sq" style="background:var(--price3)"></span> 5000 —Ä—É–±.</div>
      <div class="lg"><span class="sq" style="background:var(--price4)"></span> 5500 —Ä—É–±.</div>
    </div>

    <div class="hallTitle">–°—Ö–µ–º–∞ –∑–∞–ª–∞</div>

    <div class="hall">
      <div class="rows" id="rows"></div>
    </div>

    <div class="stage">–°—Ü–µ–Ω–∞</div>

    <div class="footer">
      <div class="total" id="total">–í—Å–µ–≥–æ: 0 —Ä—É–±.</div>
      <button class="buyBtn" id="buy">–ö—É–ø–∏—Ç—å</button>
    </div>

    <div class="form">
      <div class="field"><input id="venue" readonly></div>
      <div class="field"><input id="datetime" readonly></div>
      <div class="field"><input id="fio" placeholder="–§–ò–û"></div>
      <div class="field"><input id="phone" placeholder="–í–∞—à —Ç–µ–ª–µ—Ñ–æ–Ω"></div>
      <div class="field"><input id="email" placeholder="E-mail"></div>
      <div class="hint">–û–ø–ª–∞—Ç–∞ –ø—Ä–æ—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π —Å—á—ë—Ç (–∫–æ—à–µ–ª—ë–∫). –ï—Å–ª–∏ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç ‚Äî –ø–æ–ø–æ–ª–Ω–∏—Ç–µ –ø–æ —Å—Å—ã–ª–∫–µ –æ–ø–ª–∞—Ç—ã.</div>
    </div>
  </div>
</div>

<script>
const K = {
  EVENTS:"THEATRE_EVENTS_V2",
  BAL:"THEATRE_BALANCE_V1",
  BOOKINGS:"THEATRE_BOOKINGS_V2"
};

function rub(n){ return (n||0).toLocaleString("ru-RU"); }
function qs(k){ return new URLSearchParams(location.search).get(k); }
function loadEvents(){ return JSON.parse(localStorage.getItem(K.EVENTS)||'{"events":[]}'); }
function getBal(){ return Number(localStorage.getItem(K.BAL) || "0"); }
function setBal(v){ localStorage.setItem(K.BAL, String(v)); }
function getBookings(){ return JSON.parse(localStorage.getItem(K.BOOKINGS) || "{}"); }
function setBookings(obj){ localStorage.setItem(K.BOOKINGS, JSON.stringify(obj)); }
function formatRU(isoDate){
  const [y,m,d]=isoDate.split("-");
  return `${d}.${m}.${y}`;
}

const id = qs("id");
const {events} = loadEvents();
const e = events.find(x=>x.id===id);
if(!e){
  document.body.innerHTML = "<div style='padding:18px;font-family:Inter'>–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Å—Å—ã–ª–∫–∞</div>";
  throw new Error("bad link");
}

document.title = "–í—ã–±–æ—Ä –º–µ—Å—Ç ‚Äî " + e.title;
document.getElementById("title").textContent = e.title;
document.getElementById("meta").textContent = `${e.city}, ${formatRU(e.date)}, ${e.time}`;
document.getElementById("venue").value = e.venue;
document.getElementById("datetime").value = `${formatRU(e.date)}, ${e.time}`;
document.getElementById("back").href = `show.html?id=${encodeURIComponent(e.id)}`;
document.getElementById("bal").textContent = " " + (getBal().toLocaleString("ru-RU") + " ‚ÇΩ");

/** 7 —Ä—è–¥–æ–≤ (–∫–∞–∫ —Ç—ã –ø—Ä–æ—Å–∏–ª) */
const layout = [
  {row:7, seats:16},
  {row:6, seats:16},
  {row:5, seats:15},
  {row:4, seats:15},
  {row:3, seats:13},
  {row:2, seats:13},
  {row:1, seats:13},
];

/** –∑–æ–Ω—ã/—Ü–µ–Ω—ã ‚Äî ‚Äú—Ü–≤–µ—Ç–Ω—ã–µ –º–µ—Å—Ç–∞ —Å—Ä–µ–¥–∏ —Å–µ—Ä—ã—Ö‚Äù */
function priceFor(row, seat){
  // –±–ª–∏–∂–µ –∫ —Å—Ü–µ–Ω–µ (—Ä—è–¥ 1) ‚Äî –±–æ–ª—å—à–µ —è—Ä–∫–∏—Ö/–¥–æ—Ä–æ–≥–∏—Ö
  if(row===1){
    if([3,4,12,13].includes(seat)) return 5500;
    if([7,8,9].includes(seat)) return 5000;
    return 2500;
  }
  if(row===2){
    if([3,7,9,12,13].includes(seat)) return 3500;
    if([6,8].includes(seat)) return 5000;
    return 2500;
  }
  if(row===3){
    if([2,8,9].includes(seat)) return 3500;
    return 2500;
  }
  if(row===4){
    if([5,10,11,14].includes(seat)) return 3500;
    return 2500;
  }
  if(row===5){
    if([5,8,13].includes(seat)) return 3500;
    return 2500;
  }
  if(row===6){
    if([4,12].includes(seat)) return 2500;
    return 0; // —Å–µ—Ä—ã–µ
  }
  if(row===7){
    if([2,8].includes(seat)) return 2500;
    return 0; // —Å–µ—Ä—ã–µ
  }
  return 0;
}
function priceClass(p){
  if(p===2500) return "p2500";
  if(p===3500) return "p3500";
  if(p===5000) return "p5000";
  if(p===5500) return "p5500";
  return "";
}

/** –ó–∞–Ω—è—Ç–æ—Å—Ç—å: —Ä–∞–Ω–¥–æ–º + —á–∞—Å—Ç–æ –ø–∞—Ä–∞–º–∏ —Ä—è–¥–æ–º, –Ω–æ –æ—Å—Ç–∞–≤–ª—è–µ–º –º–Ω–æ–≥–æ —Å–≤–æ–±–æ–¥–Ω—ã—Ö –ø–∞—Ä */
const perfKey = `event|${e.id}`;
const bookings = getBookings();
bookings[perfKey] = bookings[perfKey] || { sold: {}, seeded:false };

function seededRand(str){
  let h=2166136261>>>0;
  for(let i=0;i<str.length;i++){ h^=str.charCodeAt(i); h=Math.imul(h,16777619); }
  return ()=>{ h+=h<<13; h^=h>>>7; h+=h<<3; h^=h>>>17; h+=h<<5; return ((h>>>0)%100000)/100000; };
}

if(!bookings[perfKey].seeded){
  bookings[perfKey].seeded = true;
  const r = seededRand(perfKey);

  layout.forEach(row=>{
    const count=row.seats;
    // –∑–∞–Ω—è—Ç–æ—Å—Ç—å ~10-14% –∏ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –ø–∞—Ä–∞–º–∏
    const pairs = Math.max(1, Math.floor(count * (0.10 + r()*0.04) / 2));
    for(let i=0;i<pairs;i++){
      const s = 1 + Math.floor(r()*(count-1)); // –º–µ—Å—Ç–æ + –º–µ—Å—Ç–æ —Ä—è–¥–æ–º
      // –Ω–µ –∑–∞–∂–∏–º–∞—Ç—å –∑–∞–ª –ø–æ–ª–Ω–æ—Å—Ç—å—é: –Ω–µ —Å—Ç–∞–≤–∏–º —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ø–æ–¥—Ä—è–¥
      if(bookings[perfKey].sold[`${row.row}-${s}`]) continue;
      if(bookings[perfKey].sold[`${row.row}-${s+1}`]) continue;

      bookings[perfKey].sold[`${row.row}-${s}`]=true;
      bookings[perfKey].sold[`${row.row}-${s+1}`]=true;
    }
  });

  setBookings(bookings);
}

const selected = new Set();

function recompute(){
  let sum=0;
  selected.forEach(key=>{
    const [row,seat]=key.split("-").map(Number);
    const p = priceFor(row,seat) || 2500;
    sum+=p;
  });
  document.getElementById("total").textContent = `–í—Å–µ–≥–æ: ${rub(sum)} —Ä—É–±.`;
  return sum;
}

function renderSeats(){
  const rowsEl=document.getElementById("rows");
  rowsEl.innerHTML="";
  const soldMap = bookings[perfKey].sold || {};

  layout.forEach(r=>{
    const rowEl=document.createElement("div");
    rowEl.className="row";

    const rowNum=document.createElement("div");
    rowNum.className="rowNum";
    rowNum.textContent=r.row;
    rowEl.appendChild(rowNum);

    const seats=document.createElement("div");
    seats.className="seats";

    for(let s=1;s<=r.seats;s++){
      const key=`${r.row}-${s}`;
      const btn=document.createElement("div");
      btn.className="seat";
      btn.textContent=s;

      const p=priceFor(r.row,s);
      if(p>0) btn.classList.add(priceClass(p));

      const sold=!!soldMap[key];
      if(sold) btn.classList.add("sold");
      if(selected.has(key)) btn.classList.add("sel");

      btn.onclick=()=>{
        if(sold) return;
        if(selected.has(key)) selected.delete(key);
        else selected.add(key);
        renderSeats();
        recompute();
      };

      seats.appendChild(btn);
    }

    rowEl.appendChild(seats);
    rowsEl.appendChild(rowEl);
  });

  recompute();
}

renderSeats();

document.getElementById("buy").onclick=()=>{
  const sum=recompute();
  if(sum<=0){ alert("–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—Ç–∞."); return; }

  const fio=document.getElementById("fio").value.trim();
  const phone=document.getElementById("phone").value.trim();
  const email=document.getElementById("email").value.trim();
  if(!fio || !phone || !email){
    alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –§–ò–û, —Ç–µ–ª–µ—Ñ–æ–Ω –∏ E-mail.");
    return;
  }

  const bal=getBal();
  if(bal < sum){
    const need = sum - bal;
    const go = confirm(`–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç ${need.toLocaleString("ru-RU")} ‚ÇΩ. –û—Ç–∫—Ä—ã—Ç—å —Å—Å—ã–ª–∫—É –æ–ø–ª–∞—Ç—ã –¥–ª—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è?`);
    if(go) location.href = `pay.html?amount=${encodeURIComponent(need)}&return=wallet.html`;
    return;
  }

  setBal(bal - sum);

  const b = getBookings();
  b[perfKey] = b[perfKey] || {sold:{}, seeded:true};
  selected.forEach(k=> b[perfKey].sold[k]=true);

  b[perfKey].tickets = b[perfKey].tickets || [];
  const code = "T" + Math.random().toString(36).slice(2,8).toUpperCase();
  b[perfKey].tickets.push({code,fio,phone,email,seats:[...selected],sum,ts:Date.now()});
  setBookings(b);

  alert("–°–ø–∞—Å–∏–±–æ –∑–∞ –ø–æ–∫—É–ø–∫—É!");
  selected.clear();
  document.getElementById("bal").textContent = " " + (getBal().toLocaleString("ru-RU") + " ‚ÇΩ");
  renderSeats();
};
</script>
</body>
</html>
