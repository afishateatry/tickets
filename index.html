<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>АФИША — Театр</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#f3f4f6; --card:#fff; --text:#0b0b0c; --muted:#6b7280; --line:#e5e7eb;
      --shadow:0 18px 40px rgba(0,0,0,.12);

      /* зал */
      --unavail:#8b93a6;          /* Недоступный (серый) */
      --p2500:#0f6b1d;            /* зелёный */
      --p3500:#b455d6;            /* фиолетовый */
      --p5000:#ff0000;            /* красный */
      --p5500:#00ff00;            /* ярко-зелёный */

      --btn:#0b0b0c;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:linear-gradient(#0b0b0c 0 240px, var(--bg) 240px 100%);
      color:var(--text);
    }

    /* header */
    .hero{padding:18px 14px 18px;display:flex;align-items:center;justify-content:center;gap:12px;color:#fff}
    .heroTitle{font-weight:900;letter-spacing:.06em;font-size:44px;text-transform:uppercase}
    .heroSm{width:54px;height:54px;border-radius:50%;background:#fbbf24;display:grid;place-items:center;color:#0b0b0c;font-weight:900;box-shadow:0 16px 30px rgba(0,0,0,.25);font-size:26px}
    .heroSub{text-align:center;color:#fff;opacity:.9;letter-spacing:.35em;font-weight:800;margin:-2px 0 12px}

    .wrap{max-width:980px;margin:0 auto;padding:0 12px 48px}
    .panel{background:var(--card);border:1px solid var(--line);border-radius:22px;box-shadow:var(--shadow);overflow:hidden}
    .topbar{display:flex;gap:12px;justify-content:space-between;align-items:center;padding:14px;background:#fff;border-bottom:1px solid var(--line)}
    .pill{display:inline-flex;align-items:center;gap:10px;padding:12px 16px;border:1px solid var(--line);border-radius:999px;background:#fff;color:var(--text);text-decoration:none;font-weight:900;font-size:16px;cursor:pointer}

    .screenTitle{margin:0;padding:22px 18px;text-align:center;font-size:48px;font-weight:900;border-bottom:1px solid var(--line);background:#fff}
    .note{padding:10px 14px;color:var(--muted);font-weight:800;border-bottom:1px solid var(--line);background:#fff}

    /* cards list */
    .list{display:flex;flex-direction:column}
    .item{display:grid;grid-template-columns:140px 1fr;gap:18px;padding:18px;background:#fff;border-top:1px solid var(--line);align-items:center}
    .item:first-child{border-top:none}
    .poster{width:140px;height:140px;border-radius:16px;overflow:hidden;box-shadow:0 14px 26px rgba(0,0,0,.18);background:#111}
    .poster img{width:100%;height:100%;object-fit:cover;display:block}
    .tTitle{font-size:40px;font-weight:900;line-height:1.02;margin:0 0 10px}
    .tMeta{font-size:18px;font-weight:900;margin:0 0 14px;color:#111}
    .tMeta small{display:block;color:#6b7280;font-weight:800;margin-top:6px}
    .btn{
      width:min(520px,100%);height:74px;border:none;border-radius:14px;
      background:linear-gradient(180deg,#1a1a1b,#000);color:#fff;font-weight:900;font-size:24px;
      cursor:pointer;box-shadow:0 18px 36px rgba(0,0,0,.2)
    }
    .btn:active{transform:scale(.99)}

    /* event */
    .card{background:#fff;border:1px solid var(--line);border-radius:22px;box-shadow:var(--shadow);overflow:hidden}
    .eventHead{display:grid;grid-template-columns:160px 1fr;gap:18px;padding:18px;border-bottom:1px solid var(--line);background:#fff}
    .eventHead .poster{width:160px;height:160px;border-radius:18px}
    .hint{margin-top:10px;color:#6b7280;font-weight:900;font-size:16px;text-align:center;line-height:1.2}
    .section{padding:18px;border-top:1px solid var(--line);background:#fff}
    .secTitle{font-size:54px;font-weight:900;margin:0 0 14px}
    .kv{font-size:20px;line-height:1.6}
    .kv b{font-weight:900}
    .desc{white-space:pre-wrap;color:#374151;font-size:20px;line-height:1.75}

    /* hall */
    .legend{padding:14px 18px;border-bottom:1px solid var(--line);display:flex;flex-wrap:wrap;gap:16px;align-items:center;background:#fff;font-weight:900}
    .lg{display:flex;gap:10px;align-items:center}
    .sq{width:18px;height:18px;border-radius:2px;background:#999}
    .hallTitle{margin:0;padding:18px 18px;text-align:center;color:#fff;background:linear-gradient(180deg,#1a1a1b,#000);font-weight:900;font-size:28px}
    .hall{padding:18px 18px 8px;background:#fff}
    .rows{display:flex;flex-direction:column;gap:12px;align-items:center}
    .row{display:flex;gap:10px;align-items:center}
    .rowNum{width:22px;text-align:right;font-weight:900;color:#111}
    .seats{display:flex;gap:8px;flex-wrap:nowrap}
    .seat{
      width:30px;height:30px;border-radius:2px;
      background:var(--unavail);
      color:#fff;
      display:grid;place-items:center;
      font-size:12px;font-weight:900;
      user-select:none;
      box-shadow:0 2px 0 rgba(0,0,0,.12);
    }
    .seat.na{cursor:not-allowed;filter:saturate(.85)}
    .seat.sel{outline:3px solid #111827;outline-offset:1px;cursor:pointer}
    .seat.p2500{background:var(--p2500);cursor:pointer}
    .seat.p3500{background:var(--p3500);cursor:pointer}
    .seat.p5000{background:var(--p5000);cursor:pointer}
    .seat.p5500{background:var(--p5500);cursor:pointer}

    .stage{margin:14px 18px 12px;border-radius:14px;background:linear-gradient(180deg,#1a1a1b,#000);color:#fff;text-align:center;font-weight:900;font-size:40px;padding:18px 12px}
    .footer{padding:14px 18px;border-top:1px solid var(--line);display:grid;grid-template-columns:1fr 240px;gap:12px;align-items:center;background:#fff}
    .total{font-size:54px;font-weight:900}

    .form{padding:16px 18px 22px;border-top:1px solid var(--line);background:#fff}
    .field{margin:10px 0}
    .field input{
      width:100%;
      padding:18px 16px;
      border:1px solid var(--line);
      border-radius:14px;
      font-size:18px;
      font-weight:800;
      outline:none;
      background:#fff;
    }

    /* payment */
    .payBrand{display:flex;justify-content:center;gap:12px;align-items:center;font-weight:900;font-size:42px;margin:18px 0 18px}
    .payBrand span{background:#2563eb;color:#fff;padding:6px 12px;border-radius:12px}
    .payCard{background:#fff;border:1px solid var(--line);border-radius:22px;padding:18px;box-shadow:var(--shadow)}
    .payH1{margin:0 0 10px;font-weight:900;font-size:28px}
    .paySum{font-weight:900;font-size:18px;margin:10px 0 6px}
    .payMuted{color:var(--muted);font-weight:800;line-height:1.4}
    .payBtn{
      width:100%;
      padding:16px 14px;
      border-radius:14px;
      border:1px solid var(--line);
      background:#fff;
      font-weight:900;
      font-size:16px;
      cursor:pointer;
      margin-top:10px;
    }
    .payBtn.primary{background:#4f6cf7;color:#fff;border-color:#4f6cf7}

    /* support */
    .supportBtn{
      position:fixed;right:18px;bottom:18px;width:78px;height:78px;border-radius:50%;border:none;cursor:pointer;
      background:radial-gradient(circle at 30% 30%, #60a5fa, #2563eb 55%, #1d4ed8 100%);
      box-shadow:0 20px 50px rgba(0,0,0,.28);
      display:grid;place-items:center;z-index:9999
    }
    .supportBtn svg{width:36px;height:36px;fill:#fff}

    .chat{
      position:fixed;right:18px;bottom:106px;width:min(360px, calc(100vw - 36px));
      background:#fff;border:1px solid var(--line);border-radius:16px;box-shadow:0 20px 50px rgba(0,0,0,.22);
      overflow:hidden;z-index:9999;display:none;
    }
    .chatHeader{background:#0b0b0c;color:#fff;padding:12px 12px;display:flex;justify-content:space-between;align-items:center;font-weight:900}
    .chatHeader button{background:transparent;border:none;color:#fff;font-size:18px;cursor:pointer}
    .chatBody{padding:12px;max-height:320px;overflow:auto;display:flex;flex-direction:column;gap:10px}
    .msg{padding:10px 12px;border-radius:14px;max-width:90%;font-size:14px;line-height:1.35}
    .me{background:#111827;color:#fff;align-self:flex-end}
    .bot{background:#f3f4f6;color:#111827;border:1px solid #e5e7eb}
    .chatActions{display:flex;gap:8px;padding:10px 12px;border-top:1px solid var(--line);background:#fff}
    .chatActions input{flex:1;padding:12px 12px;border:1px solid var(--line);border-radius:12px;outline:none;font-weight:800}
    .chatActions button{padding:12px 14px;border:none;border-radius:12px;background:#0b0b0c;color:#fff;font-weight:900;cursor:pointer}
    .quick{display:flex;flex-wrap:wrap;gap:8px;padding:0 12px 12px}
    .quick button{border:1px solid var(--line);background:#fff;border-radius:999px;padding:8px 10px;cursor:pointer;font-weight:900;font-size:12px}

    @media (max-width:560px){
      .heroTitle{font-size:40px}
      .screenTitle{font-size:44px}
      .item{grid-template-columns:130px 1fr}
      .poster{width:130px;height:130px}
      .tTitle{font-size:34px}
      .tMeta{font-size:16px}
      .btn{height:70px;font-size:22px}
      .eventHead{grid-template-columns:140px 1fr}
      .eventHead .poster{width:140px;height:140px}
      .secTitle{font-size:46px}
      .total{font-size:44px}
      .footer{grid-template-columns:1fr 160px}
    }
  </style>
</head>
<body>
  <div class="hero">
    <div class="heroTitle">АФИША</div>
    <div class="heroSm">☺</div>
  </div>
  <div class="heroSub">ТЕАТР</div>

  <div class="wrap" id="app"></div>

  <!-- support -->
  <button class="supportBtn" id="supportBtn" title="Support">
    <svg viewBox="0 0 24 24"><path d="M12 3C7.03 3 3 6.58 3 11c0 2.05.87 3.92 2.3 5.33L4.5 20.5l4.38-1.46c.98.29 2.03.46 3.12.46 4.97 0 9-3.58 9-8s-4.03-8-9-8zm-4 9h8a1 1 0 0 1 0 2H8a1 1 0 0 1 0-2zm0-3h8a1 1 0 1 1 0 2H8a1 1 0 0 1 0-2z"/></svg>
  </button>

  <div class="chat" id="chat">
    <div class="chatHeader">
      <div>Support</div>
      <button id="chatClose">✕</button>
    </div>
    <div class="chatBody" id="chatBody"></div>
    <div class="quick">
      <button data-q="Как купить?">Как купить?</button>
      <button data-q="Ошибка оплаты">Ошибка оплаты</button>
      <button data-q="Нужен возврат">Нужен возврат</button>
      <button data-q="Написать в Telegram">Написать в Telegram</button>
    </div>
    <div class="chatActions">
      <input id="chatInput" placeholder="Напишите сообщение...">
      <button id="chatSend">Отпр.</button>
    </div>
  </div>

<script>
/* =========================
   CONFIG
========================= */
// Поставь сюда свой Telegram support (если нужно)
const TELEGRAM_SUPPORT_LINK = "https://t.me/your_support";

/* =========================
   STORAGE
========================= */
const K = {
  MONTH:  "AFISHA_MONTH_THEATRES_V1",
  EVENTS: "AFISHA_EVENTS_THEATRES_V1",
  AVAIL:  "AFISHA_AVAIL_THEATRES_V1",   // доступные места (цветные)
  TICKETS:"AFISHA_TICKETS_V1"
};

const app = document.getElementById("app");

/* =========================
   DATE (LOCAL, NO UTC SHIFT)
========================= */
function isoLocal(d){
  const y=d.getFullYear();
  const m=String(d.getMonth()+1).padStart(2,"0");
  const day=String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${day}`;
}
function ruDate(isoDate){
  const [y,m,d]=isoDate.split("-");
  return `${d}.${m}.${y}`;
}
function yyyy_mm(d=new Date()){
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;
}
function daysInMonth(y, mIndex){ return new Date(y, mIndex+1, 0).getDate(); }
function rangeTodayToEndOfMonth(){
  const now = new Date();
  const start = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  const end = new Date(now.getFullYear(), now.getMonth()+1, 0);
  return {start,end};
}

/* =========================
   RANDOM (SEEDED)
========================= */
function seededRand(str){
  let h=2166136261>>>0;
  for(let i=0;i<str.length;i++){ h^=str.charCodeAt(i); h=Math.imul(h,16777619); }
  return ()=>{ h+=h<<13; h^=h>>>7; h+=h<<3; h^=h>>>17; h+=h<<5; return ((h>>>0)%100000)/100000; };
}
function pick(r, arr){ return arr[Math.floor(r()*arr.length)]; }
function uniqPick(r, arr, n){
  const a=[...arr];
  const out=[];
  while(out.length<n && a.length){
    const i=Math.floor(r()*a.length);
    out.push(a.splice(i,1)[0]);
  }
  return out;
}
function escapeHtml(s){
  return String(s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
}

/* =========================
   THEATRES (3 real Moscow)
========================= */
const THEATRES = [
  {
    id:"mxt",
    name:"МХТ им. А. П. Чехова",
    address:"Москва, Камергёрский пер., 3",
    seed:"MXT",
    photo:"https://images.unsplash.com/photo-1545239351-1141bd82e8a6?auto=format&fit=crop&w=900&q=70"
  },
  {
    id:"vahtangov",
    name:"Театр им. Евг. Вахтангова",
    address:"Москва, ул. Арбат, 26",
    seed:"VAHT",
    photo:"https://images.unsplash.com/photo-1507924538820-ede94a04019d?auto=format&fit=crop&w=900&q=70"
  },
  {
    id:"bolshoi",
    name:"Большой театр",
    address:"Москва, Театральная пл., 1",
    seed:"BOL",
    photo:"https://images.unsplash.com/photo-1529156069898-49953e39b3ac?auto=format&fit=crop&w=900&q=70"
  }
];

/* =========================
   DATA POOLS (big enough)
========================= */
const TIME_POOL = ["18:00","19:00","20:00","21:00","22:00"];
const A = ["Тихая","Громкая","Последняя","Первая","Скрытая","Слепая","Живая","Чёрная","Белая","Красная","Синяя","Тонкая","Ночная","Дневная","Ранняя","Поздняя","Странная","Лёгкая","Тяжёлая","Светлая","Холодная","Тёплая","Невидимая","Случайная","Короткая","Длинная","Новая","Старая","Честная","Ложная","Пустая","Полная","Смелая","Робкая"];
const N = ["линия","сцена","роль","пауза","комната","правда","ошибка","маска","тишина","память","вера","письмо","встреча","легенда","тень","мелодия","история","реплика","записка","шаг","выбор","сон","театр","занавес","рампа","галёрка","оркестр","кулисы","монолог","акт","эпилог"];
const S = ["вчера","сегодня","завтра","перед занавесом","после аплодисментов","на седьмом ряду","в оркестровой яме","за кулисами","в свете рампы","без слов","в один акт","в два голоса","в три сцены","на пустой сцене","по краю тишины"];

const DIRECTORS = ["Евгений Писарев","Илья Соколов","Марина Кузнецова","Александр Фомин","Никита Ланской","Виктория Волкова","Дмитрий Север","Елена Климова","Сергей Шевченко","Тимур Полянский"];
const ARTISTS  = ["Андреас фон Шлиппе","Мария Волошина","Ольга Миронова","Софья Мартынова","Антон Громов","Екатерина Жданова","Марина Синицына","Ирина Селезнёва"];
const PRODUCERS= ["Владимир Прудкин","Алексей Смирнов","Николай Ветров","Алина Коваль","Павел Ильин","Александр Братинов"];
const MUSIC    = ["Тимур Полянский","Алексей Смирнов","Николай Ветров","Дмитрий Север","Марина Синицына","Екатерина Жданова","Анжелика Борисова"];
const LIGHT    = ["Сергей Невгадовский","Марина Синицына","Игорь Сафонов","Елена Климова","Ксения Артемьева","Глеб Рязанов"];
const SOUND    = ["Сергей Шевченко","Алина Коваль","Николай Ветров","Дмитрий Север","Павел Ильин"];
const VIDEO    = ["Александр Братинов","Антон Громов","Павел Ильин","Елена Климова"];
const ASSIST   = ["Любовь Скирко","Дарья Зайцева","Софья Мартынова","Екатерина Жданова","Вера Степанова"];

const ACTORS = [
  "Ирина Грищенко","Константин Темляк","Ирина Мельник","Юлия Брусенцева","Сергей Невгадовский",
  "Анна Романова","Кирилл Лебедев","Ольга Селезнёва","Михаил Назаров","Павел Ильин",
  "Ксения Артемьева","Игорь Сафонов","Вера Степанова","Глеб Рязанов","Даниил Платонов",
  "Мария Волошина","Александр Фомин","Никита Ланской","Виктория Волкова","Елена Климова",
  "Антон Громов","Николай Ветров","Алина Коваль","Марина Синицына","Дарья Зайцева","Любовь Скирко"
];

const ROLES = [
  "Печорин","Грушницкий","Вера","Мери","Астров","Соня","Елена Андреевна","Войницкий",
  "Фигаро","Граф","Графиня","Сюзанна","Лир","Глостер","Шут","Эдгар",
  "Рассказчик","Странник","Хранитель сцены","Тень","Он","Она","Ведущий","Гостья",
  "Слуги просцениума","Музыкант","Суфлёр","Режиссёр в кадре","Пианист","Смотритель"
];

const THEMES = [
  "выборе и цене выбора","памяти и вине","любви и упрямстве","страхе быть собой","правде, которую не говорят вслух",
  "одиночестве в толпе","власти привычек","попытке начать заново","хрупкости доверия","силе прощения",
  "надежде в конце сезона","случайной встрече","долгом молчании","прощании со сценой","возвращении домой"
];
const MOODS = ["нежная, но острая","парадоксально смешная","тихая и пронзительная","жёсткая и честная","светлая и нервная","строгая и тонкая"];

const DESC_TEMPLATES = [
  ({title, theme, mood}) => `«${title}» — ${mood} спектакль о ${theme}.
Здесь нет простых ответов: герои спорят с судьбой, прячутся за шутками и всё равно
возвращаются к главному — что важнее: победить или не потерять себя.
Сцены собираются в единый ритм, как дыхание зала — то громче, то почти шёпотом.`,
  ({title, theme, mood}) => `Это история, в которой театр становится зеркалом.
«${title}» звучит как внутренний дневник: честно, резко и неожиданно нежно.
Мы следим за выбором героев и понимаем, что ${theme} — не сюжет, а личный опыт.
И когда занавес опускается, остаётся то, что не сыграешь: тишина и ясность.`,
  ({title, theme, mood}) => `«${title}» — ${mood} постановка, где важна каждая пауза.
Здесь ${theme} проявляется не словами, а взглядом, шагом, расстоянием между людьми.
Спектакль двигается как музыка: сначала лёгкий мотив, потом — напряжение,
и в финале — точка, после которой хочется молчать ещё минуту.`
];

/* театр-фото (прямые, без редиректов) */
const SHOW_PHOTOS = [
  "https://images.unsplash.com/photo-1485562569060-2eec283d3391?auto=format&fit=crop&w=900&q=70",
  "https://images.unsplash.com/photo-1497032628192-86f99bcd76bc?auto=format&fit=crop&w=900&q=70",
  "https://images.unsplash.com/photo-1520697830682-bbb6e85e2b0d?auto=format&fit=crop&w=900&q=70",
  "https://images.unsplash.com/photo-1521336575822-6da63fb45455?auto=format&fit=crop&w=900&q=70",
  "https://images.unsplash.com/photo-1526481280695-3c687fd5432c?auto=format&fit=crop&w=900&q=70",
  "https://images.unsplash.com/photo-1545239351-1141bd82e8a6?auto=format&fit=crop&w=900&q=70",
  "https://images.unsplash.com/photo-1507924538820-ede94a04019d?auto=format&fit=crop&w=900&q=70",
  "https://images.unsplash.com/photo-1529156069898-49953e39b3ac?auto=format&fit=crop&w=900&q=70"
];

/* =========================
   MONTH DATA: 3 theatres, each has own unique shows
========================= */
function generateUniqueTitles(count, r){
  const used=new Set();
  const out=[];
  let tries=0;
  while(out.length<count && tries<12000){
    tries++;
    const base = `${pick(r,A)} ${pick(r,N)}`;
    const full = base + (r()<0.60 ? ` — ${pick(r,S)}` : "");
    const key = full.toLowerCase();
    if(used.has(key)) continue;
    used.add(key);
    out.push(full);
  }
  while(out.length<count) out.push(`Спектакль №${out.length+1}`);
  return out;
}

function ensureMonthData(){
  const key = yyyy_mm(new Date());
  const storedKey = localStorage.getItem(K.MONTH);

  if(storedKey !== key){
    localStorage.setItem(K.MONTH, key);
    localStorage.removeItem(K.EVENTS);
    localStorage.removeItem(K.AVAIL);
    localStorage.removeItem(K.TICKETS);
  }

  if(localStorage.getItem(K.EVENTS)) return;

  const now = new Date();
  const y = now.getFullYear();
  const m = now.getMonth();
  const total = daysInMonth(y, m);

  const data = { theatres: [] };

  THEATRES.forEach((t, ti)=>{
    const r = seededRand("THEATRE|" + t.seed + "|" + key);
    const titles = generateUniqueTitles(total, r);

    const shows = [];
    for(let day=1; day<=total; day++){
      const d = new Date(y, m, day);
      const dateISO = isoLocal(d);

      const title = titles[day-1];
      const time  = pick(r, TIME_POOL);
      const poster = SHOW_PHOTOS[(day + ti*3) % SHOW_PHOTOS.length];

      const about = {
        director: pick(r, DIRECTORS),
        artist:   pick(r, ARTISTS),
        producer: pick(r, PRODUCERS),
        music:    pick(r, MUSIC),
        light:    pick(r, LIGHT),
        sound:    pick(r, SOUND),
        video:    pick(r, VIDEO),
        assistant:pick(r, ASSIST),
      };

      const castCount = 4 + Math.floor(r()*4); // 4..7
      const actors = uniqPick(r, ACTORS, castCount);
      const roles  = uniqPick(r, ROLES, castCount);
      const cast = actors.map((a,i)=>({actor:a, role: roles[i] || pick(r, ROLES)}));

      const theme = pick(r, THEMES);
      const mood  = pick(r, MOODS);
      const descFn = pick(r, DESC_TEMPLATES);
      const description = descFn({title, theme, mood});

      shows.push({
        id: `${t.id}_${dateISO}`,
        theatreId: t.id,
        theatreName: t.name,
        theatreAddress: t.address,
        city:"Москва",
        date: dateISO,
        time,
        title,
        poster,
        about,
        cast,
        description
      });
    }

    data.theatres.push({ ...t, shows });
  });

  localStorage.setItem(K.EVENTS, JSON.stringify(data));
}

function getData(){
  ensureMonthData();
  return JSON.parse(localStorage.getItem(K.EVENTS));
}

function showsForTheatre(theatreId){
  const data = getData();
  const t = data.theatres.find(x=>x.id===theatreId);
  if(!t) return [];
  const todayISO = isoLocal(new Date());
  // только от сегодня до конца месяца
  return t.shows.filter(s=>s.date >= todayISO);
}

function findShow(showId){
  const data = getData();
  for(const t of data.theatres){
    const s = t.shows.find(x=>x.id===showId);
    if(s) return s;
  }
  return null;
}

/* =========================
   HALL: exact layout + 85-90% occupied
   - ONLY COLORED ARE AVAILABLE
   - grey = Недоступный
   - per row: guaranteed adjacent pair available (2 seats)
========================= */
const HALL_LAYOUT = [
  {row:9, seats:13},
  {row:8, seats:13},
  {row:7, seats:16},
  {row:6, seats:16},
  {row:5, seats:15},
  {row:4, seats:15},
  {row:3, seats:13},
  {row:2, seats:13},
  {row:1, seats:13},
];

function rowPriceTier(row){
  // ближе к сцене дороже
  if(row<=1) return 5500;
  if(row===2) return 5000;
  if(row===3) return 3500;
  if(row===4) return 3500;
  if(row===5) return 3500;
  return 2500;
}
function priceClass(p){
  if(p===2500) return "p2500";
  if(p===3500) return "p3500";
  if(p===5000) return "p5000";
  if(p===5500) return "p5500";
  return "";
}

function getAvailStore(){
  return JSON.parse(localStorage.getItem(K.AVAIL) || "{}");
}
function setAvailStore(v){
  localStorage.setItem(K.AVAIL, JSON.stringify(v));
}

// generates available colored seats map (only available are stored)
// Total seats: 127
// Available always = 18 (2 adjacent per row) => occupied ~85.8%
function ensureAvailForShow(showId){
  const store = getAvailStore();
  if(store[showId]) return store[showId];

  const r = seededRand("AVAIL|" + showId);
  const avail = {}; // "row-seat" => price

  HALL_LAYOUT.forEach(rowObj=>{
    const row = rowObj.row;
    const seats = rowObj.seats;

    // choose start 1..seats-1; more often inside
    let start;
    if(seats>3 && r()<0.75){
      start = 2 + Math.floor(r()*(seats-2)); // 2..seats-1
      if(start>=seats) start=seats-1;
    } else {
      start = 1 + Math.floor(r()*(seats-1));
    }

    const p = rowPriceTier(row);
    avail[`${row}-${start}`] = p;
    avail[`${row}-${start+1}`] = p;
  });

  store[showId] = avail;
  setAvailStore(store);
  return avail;
}

/* =========================
   ROUTER (SPA)
========================= */
function route(){
  const hash = location.hash || "#theatres";
  const [page, param] = hash.split(":");
  if(page === "#theatre") return renderTheatre(param);
  if(page === "#show") return renderShow(param);
  if(page === "#buy") return renderBuy(param);
  if(page === "#pay") return renderPay(param);     // param = showId|sum|seatsCSV|fio|phone|email
  if(page === "#admin") return renderAdmin();      // hidden (not linked)
  return renderTheatres();
}
window.addEventListener("hashchange", route);

/* =========================
   SCREENS
========================= */
function renderTheatres(){
  const data = getData();

  app.innerHTML = `
    <div class="panel">
      <div class="topbar">
        <div class="pill" style="cursor:default">Театры</div>
        <div class="pill" onclick="openSupport()">Support</div>
      </div>
      <div class="note">Выберите театр → спектакли (сегодня → конец месяца).</div>
      <div class="screenTitle">Москва</div>
      <div class="list" id="list"></div>
    </div>
  `;

  const list = document.getElementById("list");
  data.theatres.forEach(t=>{
    const el = document.createElement("div");
    el.className="item";
    el.innerHTML = `
      <div class="poster"><img loading="lazy" alt="" src="${t.photo}"></div>
      <div>
        <div class="tTitle" style="font-size:34px">${escapeHtml(t.name)}</div>
        <div class="tMeta">
          ${escapeHtml(t.address)}
          <small>Нажмите, чтобы открыть афишу</small>
        </div>
        <button class="btn">Открыть</button>
      </div>
    `;
    el.querySelector("button").onclick = ()=> location.hash = `#theatre:${t.id}`;
    list.appendChild(el);
  });
}

function renderTheatre(theatreId){
  const data = getData();
  const theatre = data.theatres.find(x=>x.id===theatreId);
  if(!theatre){ location.hash="#theatres"; return; }

  const shows = showsForTheatre(theatreId);

  app.innerHTML = `
    <div class="panel">
      <div class="topbar">
        <div class="pill" onclick="location.hash='#theatres'">← Театры</div>
        <div class="pill" onclick="openSupport()">Support</div>
      </div>
      <div class="note"><b>${escapeHtml(theatre.name)}</b><br>${escapeHtml(theatre.address)}</div>
      <div class="screenTitle">Афиша</div>
      <div class="list" id="list"></div>
    </div>
  `;

  const list = document.getElementById("list");
  if(!shows.length){
    list.innerHTML = `<div style="padding:18px;color:#6b7280;font-weight:900">Нет доступных дат на остаток месяца.</div>`;
    return;
  }

  shows.forEach(s=>{
    const el = document.createElement("div");
    el.className="item";
    el.innerHTML = `
      <div class="poster"><img loading="lazy" alt="" src="${s.poster}"></div>
      <div>
        <div class="tTitle">${escapeHtml(s.title)}</div>
        <div class="tMeta">${escapeHtml(s.city)},<br>${ruDate(s.date)}, ${escapeHtml(s.time)},</div>
        <button class="btn">Купить</button>
      </div>
    `;
    el.querySelector("button").onclick = ()=> location.hash = `#show:${s.id}`;
    list.appendChild(el);
  });
}

function renderShow(showId){
  const s = findShow(showId);
  if(!s){ location.hash="#theatres"; return; }

  const labels = {
    director:"Режиссер-постановщик",
    artist:"Художник-постановщик",
    producer:"Продюсеры",
    music:"Музыкальное оформление",
    light:"Художник по освещению",
    sound:"Звукорежиссер",
    video:"Видео",
    assistant:"Помощник режиссера",
  };

  app.innerHTML = `
    <div class="topbar" style="border-radius:22px;box-shadow:var(--shadow);border:1px solid var(--line);margin-bottom:12px">
      <div class="pill" onclick="location.hash='#theatre:${escapeHtml(s.theatreId)}'">← Афиша</div>
      <div class="pill" onclick="openSupport()">Support</div>
    </div>

    <div class="card">
      <div class="eventHead">
        <div class="poster"><img loading="lazy" alt="" src="${s.poster}"></div>
        <div>
          <div class="tTitle">${escapeHtml(s.title)}</div>
          <div class="tMeta" style="font-size:18px">
            ${escapeHtml(s.theatreName)}<br>
            <span style="color:#6b7280;font-weight:900">${escapeHtml(s.theatreAddress)}</span><br><br>
            ${escapeHtml(s.city)}, ${ruDate(s.date)}, ${escapeHtml(s.time)}
          </div>
          <button class="btn" id="goBuy">Купить</button>
          <div class="hint">Переход на схему зала<br>→ выбор мест → оплата</div>
        </div>
      </div>

      <div class="section">
        <div class="secTitle">О событии:</div>
        <div class="kv">
          ${Object.entries(s.about).map(([k,v])=>`<div><b>${labels[k]||k}</b> — ${escapeHtml(v)}</div>`).join("")}
        </div>
      </div>

      <div class="section">
        <div class="secTitle">Актёрский<br>состав:</div>
        <div class="kv">
          ${s.cast.map(x=>`<div><b>${escapeHtml(x.actor)}</b> - ${escapeHtml(x.role)}</div>`).join("")}
        </div>
      </div>

      <div class="section">
        <div class="secTitle">Описание:</div>
        <div class="desc">${escapeHtml(s.description)}</div>
      </div>
    </div>
  `;

  document.getElementById("goBuy").onclick = ()=> location.hash = `#buy:${s.id}`;
}

function renderBuy(showId){
  const s = findShow(showId);
  if(!s){ location.hash="#theatres"; return; }

  const avail = ensureAvailForShow(s.id);
  const selected = new Set();

  app.innerHTML = `
    <div class="topbar" style="border-radius:22px;box-shadow:var(--shadow);border:1px solid var(--line);margin-bottom:12px">
      <div class="pill" onclick="location.hash='#show:${escapeHtml(s.id)}'">← Назад</div>
      <div class="pill" onclick="openSupport()">Support</div>
    </div>

    <div class="card">
      <div class="legend">
        <div class="lg"><span class="sq" style="background:var(--unavail)"></span> Недоступный</div>
        <div class="lg"><span class="sq" style="background:var(--p2500)"></span> 2500 руб.</div>
        <div class="lg"><span class="sq" style="background:var(--p3500)"></span> 3500 руб.</div>
        <div class="lg"><span class="sq" style="background:var(--p5000)"></span> 5000 руб.</div>
        <div class="lg"><span class="sq" style="background:var(--p5500)"></span> 5500 руб.</div>
      </div>

      <div class="hallTitle">Схема зала</div>

      <div class="hall">
        <div class="rows" id="rows"></div>
      </div>

      <div class="stage">Сцена</div>

      <div class="footer">
        <div class="total" id="total">Всего: 0 руб.</div>
        <button class="btn" id="buyBtn" style="height:78px">Купить</button>
      </div>

      <div class="form">
        <div class="field"><input id="venue" readonly value="${escapeHtml(s.theatreAddress)}"></div>
        <div class="field"><input id="dt" readonly value="${escapeHtml(ruDate(s.date) + ', ' + s.time)}"></div>
        <div class="field"><input id="fio" placeholder="ФИО"></div>
        <div class="field"><input id="phone" placeholder="Ваш телефон"></div>
        <div class="field"><input id="email" placeholder="E-mail"></div>
      </div>
    </div>
  `;

  function recalc(){
    let sum = 0;
    selected.forEach(k=> sum += (avail[k] || 0));
    document.getElementById("total").textContent = `Всего: ${sum.toLocaleString("ru-RU")} руб.`;
    return sum;
  }

  function renderRows(){
    const rowsEl = document.getElementById("rows");
    rowsEl.innerHTML = "";

    HALL_LAYOUT.forEach(rw=>{
      const rowEl = document.createElement("div");
      rowEl.className = "row";

      const rn = document.createElement("div");
      rn.className = "rowNum";
      rn.textContent = rw.row;
      rowEl.appendChild(rn);

      const seatsEl = document.createElement("div");
      seatsEl.className = "seats";

      for(let seatNum=1; seatNum<=rw.seats; seatNum++){
        const key = `${rw.row}-${seatNum}`;
        const p = avail[key]; // only available have price

        const seat = document.createElement("div");
        seat.className = "seat";
        seat.textContent = seatNum;

        if(p){
          seat.classList.add(priceClass(p));
          if(selected.has(key)) seat.classList.add("sel");
          seat.onclick = ()=>{
            selected.has(key) ? selected.delete(key) : selected.add(key);
            renderRows();
            recalc();
          };
        }else{
          seat.classList.add("na"); // grey
        }

        seatsEl.appendChild(seat);
      }

      rowEl.appendChild(seatsEl);
      rowsEl.appendChild(rowEl);
    });

    recalc();
  }

  renderRows();

  document.getElementById("buyBtn").onclick = ()=>{
    const sum = recalc();
    if(sum <= 0) return alert("Выберите места (свободные — цветные).");

    const fio = document.getElementById("fio").value.trim();
    const phone = document.getElementById("phone").value.trim();
    const email = document.getElementById("email").value.trim();
    if(!fio || !phone || !email) return alert("Заполните ФИО, телефон и E-mail.");

    const seatsCSV = [...selected].join(",");
    // на платежную (виртуальный счет)
    location.hash = `#pay:${encodeURIComponent(s.id)}|${encodeURIComponent(sum)}|${encodeURIComponent(seatsCSV)}|${encodeURIComponent(fio)}|${encodeURIComponent(phone)}|${encodeURIComponent(email)}`;
  };
}

function renderPay(paramRaw){
  const parts = String(paramRaw||"").split("|").map(x=>decodeURIComponent(x||""));
  const showId = parts[0];
  const sum = Number(parts[1]||0);
  const seatsCSV = parts[2]||"";
  const fio = parts[3]||"";
  const phone = parts[4]||"";
  const email = parts[5]||"";

  const s = findShow(showId);
  if(!s || !sum || !seatsCSV){
    location.hash = "#theatres";
    return;
  }

  app.innerHTML = `
    <div class="topbar" style="border-radius:22px;box-shadow:var(--shadow);border:1px solid var(--line);margin-bottom:12px">
      <div class="pill" onclick="location.hash='#buy:${escapeHtml(s.id)}'">← Назад</div>
      <div class="pill" onclick="openSupport()">Support</div>
    </div>

    <div class="payBrand">VIRTUAL <span>Pay</span></div>

    <div class="payCard">
      <div class="payH1">Быстрая оплата</div>
      <div class="paySum">Сумма: ${sum.toLocaleString("ru-RU")} ₽</div>
      <div class="payMuted">
        Плательщик: <b>${escapeHtml(fio)}</b><br>
        Телефон: <b>${escapeHtml(phone)}</b><br>
        E-mail: <b>${escapeHtml(email)}</b><br><br>
        После успешной оплаты места станут недоступными.
      </div>

      <button class="payBtn primary" data-bank="Другие банки">Другие банки ( кешбек до 10% )</button>
      <button class="payBtn" data-bank="Т-Банк">Оплатить с Т-Банк</button>
      <button class="payBtn" data-bank="Альфа Банк">АльфаБанк</button>
      <button class="payBtn" data-bank="СБЕР">СБЕР</button>

      <button class="payBtn" id="cancel" style="margin-top:14px;background:#f3f4f6">Свернуть</button>
    </div>
  `;

  function finishPayment(bank){
    // списываем выбранные места: удаляем из "доступных" => становятся серыми
    const store = getAvailStore();
    const avail = store[s.id] || {};
    seatsCSV.split(",").filter(Boolean).forEach(k=>{
      delete avail[k];
    });
    store[s.id] = avail;
    setAvailStore(store);

    // сохраняем билет (просто лог)
    const tickets = JSON.parse(localStorage.getItem(K.TICKETS)||"[]");
    const code = "T" + Math.random().toString(36).slice(2,8).toUpperCase();
    tickets.push({
      ts: Date.now(),
      code, bank,
      theatre: s.theatreName,
      address: s.theatreAddress,
      title: s.title,
      date: s.date,
      time: s.time,
      fio, phone, email,
      seats: seatsCSV,
      sum
    });
    localStorage.setItem(K.TICKETS, JSON.stringify(tickets));

    alert(`Оплата успешна (${bank}).\nСпасибо за покупку!\nБилет: ${code}`);
    location.hash = `#theatre:${s.theatreId}`;
  }

  document.querySelectorAll("button[data-bank]").forEach(b=>{
    b.onclick = ()=> finishPayment(b.dataset.bank);
  });
  document.getElementById("cancel").onclick = ()=> location.hash = `#buy:${s.id}`;
}

/* =========================
   ADMIN (hidden)
   - Not linked anywhere
   - You can open by typing: #admin
========================= */
function renderAdmin(){
  const tickets = JSON.parse(localStorage.getItem(K.TICKETS)||"[]").slice().reverse();
  app.innerHTML = `
    <div class="panel">
      <div class="topbar">
        <div class="pill" onclick="location.hash='#theatres'">← Назад</div>
        <div class="pill" onclick="if(confirm('Очистить все данные?')){localStorage.clear();location.hash='#theatres';location.reload();}">Очистить всё</div>
      </div>
      <div class="screenTitle">Админ</div>
      <div class="note">Скрытый режим. Не виден клиентам. Билеты (последние сверху).</div>
      <div class="list">
        ${tickets.length ? tickets.map(t=>`
          <div class="item" style="grid-template-columns:1fr">
            <div class="tTitle" style="font-size:28px">Билет ${escapeHtml(t.code)} — ${Number(t.sum).toLocaleString("ru-RU")} ₽</div>
            <div class="tMeta" style="font-size:16px">
              <b>${escapeHtml(t.theatre)}</b> — ${escapeHtml(t.address)}<br>
              ${escapeHtml(t.title)} — ${ruDate(t.date)} ${escapeHtml(t.time)}<br>
              ${escapeHtml(t.fio)} • ${escapeHtml(t.phone)} • ${escapeHtml(t.email)}<br>
              Места: ${escapeHtml(t.seats)} • Банк: ${escapeHtml(t.bank)}
              <small>${new Date(t.ts).toLocaleString("ru-RU")}</small>
            </div>
          </div>
        `).join("") : `<div style="padding:18px;color:#6b7280;font-weight:900">Пока нет покупок.</div>`}
      </div>
    </div>
  `;
}

/* =========================
   Support chat
========================= */
const chat = document.getElementById("chat");
const body = document.getElementById("chatBody");

function addMsg(text, who="bot"){
  const div=document.createElement("div");
  div.className="msg "+(who==="me"?"me":"bot");
  div.textContent=text;
  body.appendChild(div);
  body.scrollTop = body.scrollHeight;
}

function openSupport(){
  chat.style.display = (chat.style.display==="none" || !chat.style.display) ? "block" : "none";
  if(!body.children.length){
    addMsg("Здравствуйте! Я support. Чем помочь?");
  }
}

function botReply(q){
  const t=q.toLowerCase();
  if(t.includes("как купить")) return "Выберите театр → спектакль → места на схеме → заполните данные → оплатите на виртуальной платёжной странице.";
  if(t.includes("оплат")) return "Если оплата не проходит — попробуйте другой банк. Если нужно — напишите в Telegram.";
  if(t.includes("возврат")) return "Для возврата напишите в Telegram: ФИО, телефон, дата/время, код билета.";
  if(t.includes("telegram")) return "Открываю Telegram support…";
  return "Понял. Опишите проблему подробнее, пожалуйста.";
}

document.getElementById("supportBtn").onclick = openSupport;
document.getElementById("chatClose").onclick = ()=> chat.style.display="none";

document.getElementById("chatSend").onclick = ()=>{
  const inp=document.getElementById("chatInput");
  const q=inp.value.trim();
  if(!q) return;
  addMsg(q,"me");
  inp.value="";
  const a = botReply(q);
  addMsg(a,"bot");
  if(q.toLowerCase().includes("telegram")){
    window.open(TELEGRAM_SUPPORT_LINK, "_blank");
  }
};

document.getElementById("chatInput").addEventListener("keydown",(e)=>{
  if(e.key==="Enter") document.getElementById("chatSend").click();
});
document.querySelectorAll(".quick button").forEach(b=>{
  b.onclick=()=>{
    const q=b.dataset.q;
    document.getElementById("chatInput").value=q;
    document.getElementById("chatSend").click();
  };
});

/* =========================
   INIT
========================= */
route();
</script>
</body>
</html>
