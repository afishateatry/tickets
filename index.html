<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>АФИША — Театр</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#f3f4f6; --card:#fff; --text:#0b0b0c; --muted:#6b7280; --line:#e5e7eb;
      --shadow:0 18px 40px rgba(0,0,0,.12);

      --sold:#8b93a6;     /* Недоступный (как серо-синий на скрине) */
      --free:#d1d5db;     /* вспомогательный, почти не используется */

      --p2500:#0f6b1d;    /* зелёный */
      --p3500:#b455d6;    /* фиолетовый */
      --p5000:#ff0000;    /* красный */
      --p5500:#00ff00;    /* ярко-зелёный */
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:linear-gradient(#0b0b0c 0 240px, var(--bg) 240px 100%);
      color:var(--text);
    }
    .hero{padding:18px 14px 18px;display:flex;align-items:center;justify-content:center;gap:12px;color:#fff}
    .heroTitle{font-weight:900;letter-spacing:.06em;font-size:44px;text-transform:uppercase}
    .heroSm{width:54px;height:54px;border-radius:50%;background:#fbbf24;display:grid;place-items:center;color:#0b0b0c;font-weight:900;box-shadow:0 16px 30px rgba(0,0,0,.25);font-size:26px}
    .heroSub{text-align:center;color:#fff;opacity:.9;letter-spacing:.35em;font-weight:800;margin:-2px 0 12px}
    .wrap{max-width:980px;margin:0 auto;padding:0 12px 48px}
    .panel{background:var(--card);border:1px solid var(--line);border-radius:22px;box-shadow:var(--shadow);overflow:hidden}
    .topbar{display:flex;gap:12px;justify-content:space-between;align-items:center;padding:14px;background:#fff;border-bottom:1px solid var(--line)}
    .pill{display:inline-flex;align-items:center;gap:10px;padding:12px 16px;border:1px solid var(--line);border-radius:999px;background:#fff;color:var(--text);text-decoration:none;font-weight:900;font-size:16px;cursor:pointer}
    .screenTitle{margin:0;padding:22px 18px;text-align:center;font-size:48px;font-weight:900;border-bottom:1px solid var(--line);background:#fff}
    .note{padding:10px 14px;color:var(--muted);font-weight:800;border-bottom:1px solid var(--line);background:#fff}
    .list{display:flex;flex-direction:column}
    .item{display:grid;grid-template-columns:140px 1fr;gap:18px;padding:18px;background:#fff;border-top:1px solid var(--line);align-items:center}
    .item:first-child{border-top:none}
    .poster{width:140px;height:140px;border-radius:16px;overflow:hidden;box-shadow:0 14px 26px rgba(0,0,0,.18);background:#111}
    .poster img{width:100%;height:100%;object-fit:cover;display:block}
    .tTitle{font-size:40px;font-weight:900;line-height:1.02;margin:0 0 10px}
    .tMeta{font-size:22px;font-weight:900;margin:0 0 14px}
    .btn{
      width:min(520px,100%);height:74px;border:none;border-radius:14px;
      background:linear-gradient(180deg,#1a1a1b,#000);color:#fff;font-weight:900;font-size:24px;
      cursor:pointer;box-shadow:0 18px 36px rgba(0,0,0,.2)
    }
    .btn:active{transform:scale(.99)}

    .card{background:#fff;border:1px solid var(--line);border-radius:22px;box-shadow:var(--shadow);overflow:hidden}
    .eventHead{display:grid;grid-template-columns:160px 1fr;gap:18px;padding:18px;border-bottom:1px solid var(--line);background:#fff}
    .eventHead .poster{width:160px;height:160px;border-radius:18px}
    .hint{margin-top:10px;color:#6b7280;font-weight:900;font-size:16px;text-align:center;line-height:1.2}
    .section{padding:18px;border-top:1px solid var(--line);background:#fff}
    .secTitle{font-size:54px;font-weight:900;margin:0 0 14px}
    .kv{font-size:20px;line-height:1.6}
    .kv b{font-weight:900}
    .desc{white-space:pre-wrap;color:#374151;font-size:20px;line-height:1.75}

    /* Зал */
    .legend{padding:14px 18px;border-bottom:1px solid var(--line);display:flex;flex-wrap:wrap;gap:16px;align-items:center;background:#fff;font-weight:900}
    .lg{display:flex;gap:10px;align-items:center}
    .sq{width:18px;height:18px;border-radius:2px;background:#999}
    .hallTitle{
      margin:0;
      padding:18px 18px;
      text-align:center;
      color:#fff;
      background:linear-gradient(180deg,#1a1a1b,#000);
      font-weight:900;
      font-size:28px;
    }
    .hall{padding:18px 18px 8px;background:#fff}
    .rows{display:flex;flex-direction:column;gap:12px;align-items:center}
    .row{display:flex;gap:10px;align-items:center}
    .rowNum{width:22px;text-align:right;font-weight:900;color:#111}
    .seats{display:flex;gap:8px;flex-wrap:nowrap}
    .seat{
      width:30px;height:30px;border-radius:2px;
      background:var(--sold);
      color:#fff;
      display:grid;
      place-items:center;
      font-size:12px;
      font-weight:900;
      user-select:none;
      cursor:pointer;
      box-shadow:0 2px 0 rgba(0,0,0,.12);
    }
    .seat.na{cursor:not-allowed;filter:saturate(.8)}
    .seat.sel{outline:3px solid #111827;outline-offset:1px}
    .seat.p2500{background:var(--p2500)}
    .seat.p3500{background:var(--p3500)}
    .seat.p5000{background:var(--p5000)}
    .seat.p5500{background:var(--p5500)}

    .stage{margin:14px 18px 12px;border-radius:14px;background:linear-gradient(180deg,#1a1a1b,#000);color:#fff;text-align:center;font-weight:900;font-size:40px;padding:18px 12px}
    .footer{padding:14px 18px;border-top:1px solid var(--line);display:grid;grid-template-columns:1fr 240px;gap:12px;align-items:center;background:#fff}
    .total{font-size:54px;font-weight:900}
    .form{padding:16px 18px 22px;border-top:1px solid var(--line);background:#fff}
    .field{margin:10px 0}
    .field input{width:100%;padding:18px 16px;border:1px solid var(--line);border-radius:14px;font-size:18px;font-weight:800;outline:none}

    .supportBtn{
      position:fixed;right:18px;bottom:18px;width:78px;height:78px;border-radius:50%;border:none;cursor:pointer;
      background:radial-gradient(circle at 30% 30%, #60a5fa, #2563eb 55%, #1d4ed8 100%);
      box-shadow:0 20px 50px rgba(0,0,0,.28);
      display:grid;place-items:center;z-index:9999
    }
    .supportBtn svg{width:36px;height:36px;fill:#fff}

    @media (max-width:560px){
      .heroTitle{font-size:40px}
      .screenTitle{font-size:44px}
      .item{grid-template-columns:130px 1fr}
      .poster{width:130px;height:130px}
      .tTitle{font-size:36px}
      .tMeta{font-size:20px}
      .btn{height:70px;font-size:22px}
      .eventHead{grid-template-columns:140px 1fr}
      .eventHead .poster{width:140px;height:140px}
      .secTitle{font-size:46px}
      .total{font-size:44px}
      .footer{grid-template-columns:1fr 160px}
    }
  </style>
</head>
<body>
  <div class="hero">
    <div class="heroTitle">АФИША</div>
    <div class="heroSm">☺</div>
  </div>
  <div class="heroSub">ТЕАТР</div>

  <div class="wrap" id="app"></div>

  <button class="supportBtn" id="supportBtn" title="Support">
    <svg viewBox="0 0 24 24"><path d="M12 3C7.03 3 3 6.58 3 11c0 2.05.87 3.92 2.3 5.33L4.5 20.5l4.38-1.46c.98.29 2.03.46 3.12.46 4.97 0 9-3.58 9-8s-4.03-8-9-8zm-4 9h8a1 1 0 0 1 0 2H8a1 1 0 0 1 0-2zm0-3h8a1 1 0 1 1 0 2H8a1 1 0 0 1 0-2z"/></svg>
  </button>

<script>
/* =========================
   STORAGE + LIVE MONTH
========================= */
const K = {
  EVENTS: "AFISHA_EVENTS_MONTH_V4",
  MONTH:  "AFISHA_MONTH_V4",
  SOLD:   "AFISHA_SOLD_V4"
};

const app = document.getElementById("app");

/* ---- local date (NO UTC SHIFT) ---- */
function isoLocal(d){
  const y=d.getFullYear();
  const m=String(d.getMonth()+1).padStart(2,"0");
  const day=String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${day}`;
}
function ruDate(isoDate){
  const [y,m,d]=isoDate.split("-");
  return `${d}.${m}.${y}`;
}
function yyyy_mm(d=new Date()){
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;
}
function daysInMonth(y, mIndex){
  return new Date(y, mIndex+1, 0).getDate();
}
function seededRand(str){
  let h=2166136261>>>0;
  for(let i=0;i<str.length;i++){ h^=str.charCodeAt(i); h=Math.imul(h,16777619); }
  return ()=>{ h+=h<<13; h^=h>>>7; h+=h<<3; h^=h>>>17; h+=h<<5; return ((h>>>0)%100000)/100000; };
}
function pick(r, arr){ return arr[Math.floor(r()*arr.length)]; }
function uniqPick(r, arr, n){
  const a=[...arr];
  const out=[];
  while(out.length<n && a.length){
    const i=Math.floor(r()*a.length);
    out.push(a.splice(i,1)[0]);
  }
  return out;
}
function escapeHtml(s){
  return String(s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
}

/* =========================
   REALISTIC DATA POOLS
========================= */
const TIME_POOL = ["18:00","19:00","20:00","21:00","22:00"];

const DIRECTORS = ["Евгений Писарев","Илья Соколов","Марина Кузнецова","Александр Фомин","Никита Ланской","Виктория Волкова","Дмитрий Север","Елена Климова","Сергей Шевченко","Тимур Полянский"];
const ARTISTS  = ["Андреас фон Шлиппе","Мария Волошина","Ольга Миронова","Софья Мартынова","Антон Громов","Екатерина Жданова","Марина Синицына","Ирина Селезнёва"];
const PRODUCERS= ["Владимир Прудкин","Алексей Смирнов","Николай Ветров","Алина Коваль","Павел Ильин","Александр Братинов"];
const MUSIC    = ["Тимур Полянский","Алексей Смирнов","Николай Ветров","Дмитрий Север","Марина Синицына","Екатерина Жданова","Анжелика Борисова"];
const LIGHT    = ["Сергей Невгадовский","Марина Синицына","Игорь Сафонов","Елена Климова","Ксения Артемьева","Глеб Рязанов"];
const SOUND    = ["Сергей Шевченко","Алина Коваль","Николай Ветров","Дмитрий Север","Павел Ильин"];
const VIDEO    = ["Александр Братинов","Антон Громов","Павел Ильин","Елена Климова"];
const ASSIST   = ["Любовь Скирко","Дарья Зайцева","Софья Мартынова","Екатерина Жданова","Вера Степанова"];

const ACTORS = [
  "Ирина Грищенко","Константин Темляк","Ирина Мельник","Юлия Брусенцева","Сергей Невгадовский",
  "Анна Романова","Кирилл Лебедев","Ольга Селезнёва","Михаил Назаров","Павел Ильин",
  "Ксения Артемьева","Игорь Сафонов","Вера Степанова","Глеб Рязанов","Даниил Платонов",
  "Мария Волошина","Александр Фомин","Никита Ланской","Виктория Волкова","Елена Климова",
  "Антон Громов","Николай Ветров","Алина Коваль","Марина Синицына"
];

const ROLES = [
  "Печорин","Грушницкий","Вера","Мери","Астров","Соня","Елена Андреевна","Войницкий",
  "Фигаро","Граф","Графиня","Сюзанна","Лир","Глостер","Шут","Эдгар",
  "Рассказчик","Странник","Хранитель сцены","Тень","Он","Она","Ведущий","Гостья",
  "Слуги просцениума","Музыкант","Суфлёр","Режиссёр в кадре"
];

const DESC_TEMPLATES = [
  ({title, theme, mood}) => `«${title}» — ${mood} спектакль о ${theme}.
Здесь нет простых ответов: герои спорят с судьбой, прячутся за шутками и всё равно
возвращаются к главному — что важнее: победить или не потерять себя.
Сцены собираются в единый ритм, как дыхание зала — то громче, то почти шёпотом.`,
  ({title, theme, mood}) => `Это история, в которой театр становится зеркалом.
«${title}» звучит как внутренний дневник: честно, резко и неожиданно нежно.
Мы следим за выбором героев и понимаем, что ${theme} — не сюжет, а личный опыт.
И когда занавес опускается, остаётся то, что не сыграешь: тишина и ясность.`,
  ({title, theme, mood}) => `«${title}» — ${mood} постановка, где важна каждая пауза.
Здесь ${theme} проявляется не словами, а взглядом, шагом, расстоянием между людьми.
Спектакль двигается как музыка: сначала лёгкий мотив, потом — напряжение,
и в финале — точка, после которой хочется молчать ещё минуту.`
];
const THEMES = [
  "выборе и цене выбора","памяти и вине","любви и упрямстве","страхе быть собой","правде, которую не говорят вслух",
  "одиночестве в толпе","власти привычек","попытке начать заново","хрупкости доверия","силе прощения",
  "надежде в конце сезона","случайной встрече","долгом молчании","прощании со сценой","возвращении домой"
];
const MOODS = ["нежная, но острая","парадоксально смешная","тихая и пронзительная","жёсткая и честная","светлая и нервная","строгая и тонкая"];

/* =========================
   UNIQUE TITLES FOR WHOLE MONTH (NO REPEATS)
========================= */
function generateUniqueTitles(count, r){
  const A = [
    "Тихая","Громкая","Последняя","Первая","Скрытая","Слепая","Живая","Чёрная","Белая","Красная","Синяя",
    "Тонкая","Ночная","Дневная","Ранняя","Поздняя","Странная","Лёгкая","Тяжёлая","Светлая","Холодная","Тёплая",
    "Невидимая","Случайная","Короткая","Длинная","Новая","Старая","Честная","Ложная"
  ];
  const N = [
    "линия","сцена","роль","пауза","комната","правда","ошибка","маска","тишина","память","вера","письмо","встреча",
    "легенда","тень","мелодия","афиша","история","реплика","записка","шаг","выбор","сон","театр","занавес",
    "рампа","галёрка","оркестр","кулисы","монолог"
  ];
  const S = [
    "вчера","сегодня","завтра","перед занавесом","после аплодисментов","на седьмом ряду","в оркестровой яме",
    "за кулисами","в свете рампы","без слов","в один акт","в два голоса","в три сцены","на пустой сцене"
  ];

  const used=new Set();
  const out=[];
  let tries=0;
  while(out.length<count && tries<8000){
    tries++;
    const base = `${pick(r,A)} ${pick(r,N)}`;
    const full = base + (r()<0.60 ? ` — ${pick(r,S)}` : "");
    const key = full.toLowerCase();
    if(used.has(key)) continue;
    used.add(key);
    out.push(full);
  }
  while(out.length<count) out.push(`Спектакль №${out.length+1}`);
  return out;
}

/* =========================
   THEATRE PHOTOS (MORE THEATRE-LIKE)
   (Unsplash source with theatre keywords; sig fixes repetition)
========================= */
function theatrePoster(sig){
  const keywords = [
    "theatre,stage", "opera,stage", "theater,auditorium", "theatre,curtain", "theatre,seats",
    "theater,lights", "opera,house", "theatre,performance", "stage,spotlight", "theatre,interior"
  ];
  const q = keywords[sig % keywords.length];
  return `https://source.unsplash.com/900x900/?${encodeURIComponent(q)}&sig=${sig}`;
}

/* =========================
   MONTH EVENTS (1..end of month), then filter (today..end)
========================= */
function ensureMonthEvents(){
  const key = yyyy_mm(new Date());
  const storedKey = localStorage.getItem(K.MONTH);

  // new month -> rebuild + clear sold
  if(storedKey !== key){
    localStorage.setItem(K.MONTH, key);
    localStorage.removeItem(K.EVENTS);
    localStorage.removeItem(K.SOLD);
  }

  if(localStorage.getItem(K.EVENTS)) return;

  const now = new Date();
  const y = now.getFullYear();
  const m = now.getMonth();
  const total = daysInMonth(y, m);

  const r = seededRand("MONTH|" + key);
  const titles = generateUniqueTitles(total, r);

  const events = [];
  for(let day=1; day<=total; day++){
    const d = new Date(y, m, day);
    const dateISO = isoLocal(d);

    const title = titles[day-1];
    const time  = pick(r, TIME_POOL);
    const poster = theatrePoster(day);

    const about = {
      director: pick(r, DIRECTORS),
      artist:   pick(r, ARTISTS),
      producer: pick(r, PRODUCERS),
      music:    pick(r, MUSIC),
      light:    pick(r, LIGHT),
      sound:    pick(r, SOUND),
      video:    pick(r, VIDEO),
      assistant:pick(r, ASSIST),
    };

    const castCount = 4 + Math.floor(r()*4); // 4..7
    const actors = uniqPick(r, ACTORS, castCount);
    const roles  = uniqPick(r, ROLES, castCount);
    const cast = actors.map((a,i)=>({actor:a, role: roles[i] || pick(r, ROLES)}));

    const theme = pick(r, THEMES);
    const mood  = pick(r, MOODS);
    const descFn = pick(r, DESC_TEMPLATES);
    const description = descFn({title, theme, mood});

    events.push({
      id: "e_" + dateISO,
      title,
      city:"Москва",
      venue:"Москва, ул. Большая Садовая 6",
      date: dateISO,
      time,
      poster,
      about,
      cast,
      description
    });
  }

  localStorage.setItem(K.EVENTS, JSON.stringify({events}));
}

function liveEvents(){
  ensureMonthEvents();
  const {events} = JSON.parse(localStorage.getItem(K.EVENTS) || '{"events":[]}');
  const todayISO = isoLocal(new Date()); // local today
  return events.filter(e => e.date >= todayISO);
}

function findEvent(id){
  const {events} = JSON.parse(localStorage.getItem(K.EVENTS) || '{"events":[]}');
  return events.find(x=>x.id===id);
}

/* =========================
   ROUTER (SPA)
========================= */
function route(){
  const hash = location.hash || "#afisha";
  const [page, param] = hash.split(":");
  if(page === "#event") return renderEvent(param);
  if(page === "#buy") return renderBuy(param);
  if(page === "#reset"){
    localStorage.removeItem(K.EVENTS);
    localStorage.removeItem(K.SOLD);
    location.hash = "#afisha";
    return;
  }
  return renderAfisha();
}
window.addEventListener("hashchange", route);

/* =========================
   SCREENS
========================= */
function renderAfisha(){
  const events = liveEvents();

  app.innerHTML = `
    <div class="panel">
      <div class="topbar">
        <div class="pill" onclick="location.hash='#afisha'">← Афиша</div>
        <div class="pill" onclick="location.hash='#reset'">Сброс</div>
      </div>
      <div class="note">Показываем только с сегодняшнего дня до конца месяца. Завтра “вчера” исчезнет автоматически.</div>
      <div class="screenTitle">Театр</div>
      <div class="list" id="list"></div>
    </div>
  `;

  const list = document.getElementById("list");
  events.forEach(e=>{
    const el = document.createElement("div");
    el.className="item";
    el.innerHTML = `
      <div class="poster"><img alt="" src="${e.poster}"></div>
      <div>
        <div class="tTitle">${e.title}</div>
        <div class="tMeta">${e.city},<br>${ruDate(e.date)}, ${e.time},</div>
        <button class="btn">Купить</button>
      </div>
    `;
    el.querySelector("button").onclick = ()=> location.hash = `#event:${e.id}`;
    list.appendChild(el);
  });
}

function renderEvent(id){
  const e = findEvent(id);
  if(!e){ location.hash="#afisha"; return; }

  const labels = {
    director:"Режиссер-постановщик",
    artist:"Художник-постановщик",
    producer:"Продюсеры",
    music:"Музыкальное оформление",
    light:"Художник по освещению",
    sound:"Звукорежиссер",
    video:"Видео",
    assistant:"Помощник режиссера",
  };

  app.innerHTML = `
    <div class="topbar" style="border-radius:22px;box-shadow:var(--shadow);border:1px solid var(--line);margin-bottom:12px">
      <div class="pill" onclick="location.hash='#afisha'">← Афиша</div>
      <div class="pill" onclick="location.hash='#buy:${e.id}'">Купить</div>
    </div>

    <div class="card">
      <div class="eventHead">
        <div class="poster"><img alt="" src="${e.poster}"></div>
        <div>
          <div class="tTitle">${e.title}</div>
          <div class="tMeta">${e.city},<br>${ruDate(e.date)}, ${e.time}</div>
          <button class="btn" id="goBuy">Купить</button>
          <div class="hint">Переход на схему зала<br>→ выбор мест → покупка</div>
        </div>
      </div>

      <div class="section">
        <div class="secTitle">О событии:</div>
        <div class="kv">
          ${Object.entries(e.about).map(([k,v])=>`<div><b>${labels[k]||k}</b> — ${escapeHtml(v)}</div>`).join("")}
        </div>
      </div>

      <div class="section">
        <div class="secTitle">Актёрский<br>состав:</div>
        <div class="kv">
          ${e.cast.map(x=>`<div><b>${escapeHtml(x.actor)}</b> - ${escapeHtml(x.role)}</div>`).join("")}
        </div>
      </div>

      <div class="section">
        <div class="secTitle">Описание:</div>
        <div class="desc">${escapeHtml(e.description)}</div>
      </div>
    </div>
  `;
  document.getElementById("goBuy").onclick = ()=> location.hash = `#buy:${e.id}`;
}

/* =========================
   SEAT MAP EXACT SHAPE + COLORS + 85-90% OCCUPIED
   - Grey = Недоступный
   - Colored = доступный по цене
   - Guarantee: in EACH row there is one adjacent pair available
========================= */
const HALL_LAYOUT = [
  {row:9, seats:13},
  {row:8, seats:13},
  {row:7, seats:16},
  {row:6, seats:16},
  {row:5, seats:15},
  {row:4, seats:15},
  {row:3, seats:13},
  {row:2, seats:13},
  {row:1, seats:13},
];

// ценовой “рядовой” профиль (чтобы как на скрине были все цвета)
function rowPriceTier(row){
  if(row<=1) return 5500;
  if(row===2) return 5000;
  if(row===3) return 3500;
  if(row===4) return 3500;
  if(row===5) return 3500;
  return 2500;
}
function priceClass(p){
  if(p===2500) return "p2500";
  if(p===3500) return "p3500";
  if(p===5000) return "p5000";
  if(p===5500) return "p5500";
  return "";
}

function getSoldStore(){
  return JSON.parse(localStorage.getItem(K.SOLD) || "{}");
}
function setSoldStore(v){
  localStorage.setItem(K.SOLD, JSON.stringify(v));
}

// Generate availability map:
// - total occupied 85-90% => available 10-15%
// - we guarantee 1 pair per row (2 available seats per row) => 18 available / 127 = 14.17% (OK)
// - all other seats are grey "Недоступный"
// - pair position varies per event (seeded), so not одинаково
function ensureAvailabilityForEvent(eventId){
  const store = getSoldStore();
  if(store[eventId]) return store[eventId];

  const r = seededRand("AVAIL|" + eventId);
  const avail = {}; // key: "row-seat" => price (available). All others are grey/unavailable.

  HALL_LAYOUT.forEach(rowObj=>{
    const row = rowObj.row;
    const seats = rowObj.seats;

    // choose pair start 1..seats-1
    // also avoid extreme edges often (more realistic): 70% choose inside
    let start;
    if(seats > 3 && r() < 0.70){
      start = 2 + Math.floor(r()*(seats-2)); // 2..seats-1
      if(start >= seats) start = seats-1;
    } else {
      start = 1 + Math.floor(r()*(seats-1));
    }

    const p = rowPriceTier(row);

    avail[`${row}-${start}`] = p;
    avail[`${row}-${start+1}`] = p;
  });

  store[eventId] = avail;
  setSoldStore(store);
  return avail;
}

function renderBuy(id){
  const e = findEvent(id);
  if(!e){ location.hash="#afisha"; return; }

  const avail = ensureAvailabilityForEvent(e.id);
  const selected = new Set();

  app.innerHTML = `
    <div class="topbar" style="border-radius:22px;box-shadow:var(--shadow);border:1px solid var(--line);margin-bottom:12px">
      <div class="pill" onclick="location.hash='#event:${e.id}'">← Назад</div>
      <div class="pill" onclick="location.hash='#afisha'">Афиша</div>
    </div>

    <div class="card">
      <div class="legend">
        <div class="lg"><span class="sq" style="background:var(--sold)"></span> Недоступный</div>
        <div class="lg"><span class="sq" style="background:var(--p2500)"></span> 2500 руб.</div>
        <div class="lg"><span class="sq" style="background:var(--p3500)"></span> 3500 руб.</div>
        <div class="lg"><span class="sq" style="background:var(--p5000)"></span> 5000 руб.</div>
        <div class="lg"><span class="sq" style="background:var(--p5500)"></span> 5500 руб.</div>
      </div>

      <div class="hallTitle">Схема зала</div>

      <div class="hall">
        <div class="rows" id="rows"></div>
      </div>

      <div class="stage">Сцена</div>

      <div class="footer">
        <div class="total" id="total">Всего: 0 руб.</div>
        <button class="btn" id="buyBtn" style="height:78px">Купить</button>
      </div>

      <div class="form">
        <div class="field"><input id="venue" readonly value="${escapeHtml(e.venue)}"></div>
        <div class="field"><input id="dt" readonly value="${escapeHtml(ruDate(e.date) + ', ' + e.time)}"></div>
        <div class="field"><input id="fio" placeholder="ФИО"></div>
        <div class="field"><input id="phone" placeholder="Ваш телефон"></div>
        <div class="field"><input id="email" placeholder="E-mail"></div>
      </div>
    </div>
  `;

  function recalc(){
    let sum = 0;
    selected.forEach(key=>{
      sum += avail[key] || 0;
    });
    document.getElementById("total").textContent = `Всего: ${sum.toLocaleString("ru-RU")} руб.`;
    return sum;
  }

  function renderRows(){
    const rowsEl = document.getElementById("rows");
    rowsEl.innerHTML = "";

    HALL_LAYOUT.forEach(rw=>{
      const rowEl = document.createElement("div");
      rowEl.className = "row";

      const rn = document.createElement("div");
      rn.className = "rowNum";
      rn.textContent = rw.row;
      rowEl.appendChild(rn);

      const seatsEl = document.createElement("div");
      seatsEl.className = "seats";

      for(let s=1; s<=rw.seats; s++){
        const key = `${rw.row}-${s}`;
        const p = avail[key]; // if exists => available with that price, else unavailable grey

        const seat = document.createElement("div");
        seat.className = "seat";
        seat.textContent = s;

        if(p){
          seat.classList.add(priceClass(p));
          if(selected.has(key)) seat.classList.add("sel");
          seat.onclick = ()=>{
            if(selected.has(key)) selected.delete(key);
            else selected.add(key);
            renderRows();
            recalc();
          };
        } else {
          seat.classList.add("na"); // grey, not clickable
        }

        seatsEl.appendChild(seat);
      }

      rowEl.appendChild(seatsEl);
      rowsEl.appendChild(rowEl);
    });

    recalc();
  }

  renderRows();

  document.getElementById("buyBtn").onclick = ()=>{
    const sum = recalc();
    if(sum <= 0) return alert("Выберите места (свободные — цветные).");

    const fio = document.getElementById("fio").value.trim();
    const phone = document.getElementById("phone").value.trim();
    const email = document.getElementById("email").value.trim();
    if(!fio || !phone || !email) return alert("Заполните ФИО, телефон и E-mail.");

    // после покупки делаем выбранные места недоступными (серые)
    const store = getSoldStore();
    const a = store[e.id] || {};
    selected.forEach(k=>{
      delete a[k]; // удаляем из доступных => станет серым
    });
    store[e.id] = a;
    setSoldStore(store);

    alert("Спасибо за покупку!");
    location.hash = "#afisha";
  };
}

/* =========================
   Support button
========================= */
document.getElementById("supportBtn").onclick = ()=>{
  alert("Support: сюда можно вставить ссылку на Telegram/WhatsApp.\nНапример: https://t.me/your_support");
};

/* =========================
   Start
========================= */
route();
</script>
</body>
</html>
